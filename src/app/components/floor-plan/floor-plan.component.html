<div class="floor-plan-container" [class.fullscreen]="isFullscreen">
  <canvas #canvas></canvas>

  <div class="floating-header" (click)="$event.stopPropagation()">
    <ion-button
      *ngIf="showBackButton"
      class="circle-btn shadow-btn"
      (click)="backRequested.emit()"
    >
      <ion-icon slot="icon-only" name="chevron-back"></ion-icon>
    </ion-button>
    
    <div class="header-pill shadow-btn" *ngIf="!isFullscreen && (headerTitle || floorData?.floorName)">
      <span>{{ headerTitle || floorData?.floorName }}</span>
    </div>

    <ion-button
      class="circle-btn shadow-btn"
      style="margin-left: auto;" 
      (click)="toggleFullscreen()"
    >
      <ion-icon [name]="isFullscreen ? 'contract' : 'expand'" slot="icon-only"></ion-icon>
    </ion-button>
  </div>

  <div class="floating-bottom-left" *ngIf="!isFullscreen" (click)="$event.stopPropagation()">
    <div class="info-pill shadow-btn clickable" id="floor-trigger-btn">
      <ion-icon name="layers" color="primary"></ion-icon>
      <span>ชั้น {{ activeFloorValue }}</span>
      <ion-icon name="chevron-down" size="small" color="medium"></ion-icon>
    </div>
    <ion-popover trigger="floor-trigger-btn" triggerAction="click" alignment="start" class="floor-popover">
       <ng-template>
        <ion-content class="ion-no-padding">
          <ion-list lines="none">
            <ion-item button *ngFor="let option of floorOptions" (click)="selectFloor(option.value)" [detail]="false">
              <ion-label [class.fw-bold]="activeFloorValue === option.value">{{ option.label }}</ion-label>
              <ion-icon *ngIf="activeFloorValue === option.value" name="checkmark" slot="end" color="primary"></ion-icon>
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-popover>

    <div class="info-pill shadow-btn" *ngIf="interaction.currentZoneId$ | async as zoneId">
      <ion-icon name="location" color="secondary"></ion-icon>
      <span>{{ zoneId }}</span>
    </div>
  </div>

  <div class="floating-bottom-right" *ngIf="!isFullscreen" (click)="$event.stopPropagation()">
    
    <ion-button 
      class="circle-btn shadow-btn" 
      (click)="toggleView()"
    >
      <span class="btn-text-content">
        {{ currentView === 'iso' ? '3D' : '2D' }}
      </span>
    </ion-button>

    <ion-button 
      class="circle-btn shadow-btn" 
      (click)="toggleJoystickVisibility()"
      [style.--color]="isJoystickVisible ? 'var(--ion-color-primary)' : '#666'"
    >
      <span class="btn-text-content">
        {{ isJoystickVisible ? 'ON' : 'OFF' }}
      </span>
    </ion-button>

    <div class="zoom-stack shadow-btn">
      <ion-button class="zoom-btn" (click)="adjustCameraZoom('in')" [disabled]="!canZoomIn">
        <ion-icon slot="icon-only" name="add"></ion-icon>
      </ion-button>
      <div style="width: 20px; height: 1px; background: #ddd;"></div>
      <ion-button class="zoom-btn" (click)="adjustCameraZoom('out')" [disabled]="!canZoomOut">
        <ion-icon slot="icon-only" name="remove"></ion-icon>
      </ion-button>
    </div>

  </div>

  <app-joystick *ngIf="isJoystickVisible"></app-joystick>

</div>

<ion-modal
  [isOpen]="detailDialogVisible"
  (didDismiss)="onDialogHide()"
  class="centered-detail-modal"
  [backdropDismiss]="true"
>
  <ng-template>
    <div class="modal-wrapper-custom" style="background: #fff; padding: 20px; width: 100%;">
      <div class="modal-header" style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <h5 style="margin:0; font-weight:700;">รายละเอียด</h5>
        <ion-button fill="clear" size="small" color="medium" (click)="onDialogHide()">
          <ion-icon slot="icon-only" name="close"></ion-icon>
        </ion-button>
      </div>

      <div class="modal-body" *ngIf="interaction.selectedObject$ | async as selected">
        <h2 style="margin:0;">{{ selected.data?.name || selected.data?.id }}</h2>
        <p style="color:#666; margin-top:4px;">{{ selected.type | titlecase }} • ชั้น {{ selected.data?.floor ?? floorData?.floor }}</p>

        <ng-container [ngSwitch]="selected.type">
          <div *ngSwitchCase="'door'" style="background:#f9f9f9; padding:10px; border-radius:10px; margin-top:10px;">
             <div style="display:flex; justify-content:space-between;">
               <span>สถานะ</span>
               <ng-container *ngIf="interaction.permissionList$ | async as list">
                  <span [style.color]="list.includes(selected.data.id) ? 'green' : 'red'" style="font-weight:bold;">
                    {{ list.includes(selected.data.id) ? 'UNLOCKED' : 'LOCKED' }}
                  </span>
               </ng-container>
             </div>
          </div>
          <div *ngSwitchDefault style="margin-top:10px;">
            <p>{{ selected.data?.description || 'ไม่มีข้อมูลเพิ่มเติม' }}</p>
          </div>
        </ng-container>
      </div>
      
      <div class="modal-footer" style="margin-top: 20px;">
        <ion-button expand="block" (click)="onDialogHide()">ตกลง</ion-button>
      </div>
    </div>
  </ng-template>
</ion-modal>