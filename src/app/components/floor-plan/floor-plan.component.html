<div [class.fullscreen]="isFullscreen" class="floor-plan-wrapper">
  <canvas #canvas></canvas>

  <div class="floating-topbar" *ngIf="headerTitle || showBackButton" (click)="$event.stopPropagation()">
    <ion-button
      *ngIf="showBackButton"
      fill="clear"
      class="back-chip"
      shape="round"
      (click)="backRequested.emit()"
      aria-label="ย้อนกลับ"
    >
      <ion-icon slot="start" name="chevron-back"></ion-icon>
      กลับ
    </ion-button>

    <div class="topbar-title">
      <p class="eyebrow">การสำรวจ</p>
      <h3>{{ headerTitle || floorData?.floorName }}</h3>
    </div>

    <ion-button
      fill="clear"
      class="toolbar-icon-button"
      shape="round"
      (click)="toggleFullscreen()"
      aria-label="สลับโหมดเต็มหน้าจอ"
    >
      <ion-icon [name]="isFullscreen ? 'contract-outline' : 'expand-outline'" slot="icon-only"></ion-icon>
    </ion-button>
  </div>

  <div class="floating-footer" (click)="$event.stopPropagation()">
    <div class="footer-left" *ngIf="floorData">
      <div class="floor-select-pill" *ngIf="floorOptions.length">
        <ion-icon name="layers-outline"></ion-icon>
        <ion-select
          interface="popover"
          [value]="activeFloorValue"
          (ionChange)="onFloorSelectionChange($event.detail.value)"
          placeholder="เลือกชั้น"
        >
          <ion-select-option *ngFor="let option of floorOptions" [value]="option.value">
            {{ option.label }}
          </ion-select-option>
        </ion-select>
      </div>

      <div class="status-pill" *ngIf="interaction.currentZoneId$ | async as zoneId">
        <ion-icon name="location-outline"></ion-icon>
        <span>ตำแหน่ง: {{ zoneId }}</span>
      </div>
    </div>

    <div class="footer-actions">
      <div class="view-toggle-group" role="group" aria-label="สลับมุมมอง">
        <ion-button
          shape="round"
          fill="solid"
          [color]="currentView === 'top' ? 'primary' : 'light'"
          class="toggle-button"
          (click)="setView('top')"
        >
          <ion-icon slot="icon-only" name="map-outline"></ion-icon>
          <span>2D</span>
        </ion-button>
        <ion-button
          shape="round"
          fill="solid"
          [color]="currentView === 'iso' ? 'primary' : 'light'"
          class="toggle-button"
          (click)="setView('iso')"
        >
          <ion-icon slot="icon-only" name="cube-outline"></ion-icon>
          <span>3D</span>
        </ion-button>
      </div>
    </div>
  </div>

  <div class="camera-control-stack" (click)="$event.stopPropagation()">
    <div class="joystick-toggle-chip">
      <span>Joystick</span>
      <ion-segment
        class="chip-toggle"
        mode="ios"
        [value]="isJoystickVisible ? 'on' : 'off'"
        (ionChange)="onJoystickModeChange($event.detail.value)"
      >
        <ion-segment-button value="on">ON</ion-segment-button>
        <ion-segment-button value="off">OFF</ion-segment-button>
      </ion-segment>
    </div>

    <div class="zoom-controls">
      <ion-button
        fill="solid"
        shape="round"
        size="small"
        class="zoom-button"
        (click)="adjustCameraZoom('in')"
        [disabled]="!canZoomIn"
        aria-label="ซูมเข้า"
      >
        <ion-icon slot="icon-only" name="add"></ion-icon>
      </ion-button>
      <ion-button
        fill="solid"
        shape="round"
        size="small"
        class="zoom-button"
        (click)="adjustCameraZoom('out')"
        [disabled]="!canZoomOut"
        aria-label="ซูมออก"
      >
        <ion-icon slot="icon-only" name="remove"></ion-icon>
      </ion-button>
    </div>
  </div>

  <app-joystick *ngIf="isJoystickVisible"></app-joystick>
</div>

<ion-modal
  [isOpen]="detailDialogVisible"
  (didDismiss)="onDialogHide()"
  cssClass="floor-detail-modal"
  [backdropDismiss]="true"
>
  <ng-template>
    <ion-header>
      <ion-toolbar color="light">
        <ion-title>รายละเอียดพื้นที่</ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" (click)="onDialogHide()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div *ngIf="interaction.selectedObject$ | async as selected" class="detail-content" (click)="$event.stopPropagation()">
        <div class="detail-header">
          <h3>{{ selected.data?.name || selected.data?.id }}</h3>
          <p class="detail-subtitle">
            {{ selected.type | titlecase }} • ชั้น {{ selected.data?.floor ?? floorData?.floor }}
          </p>
        </div>

        <ng-container [ngSwitch]="selected.type">
          <div class="detail-section" *ngSwitchCase="'door'">
            <h4>สิทธิ์การเข้าใช้งาน</h4>
            <p>
              <strong>ID ประตู:</strong>
              {{ selected.data.id }}
            </p>
            <p>
              <strong>สถานะ:</strong>
              <ng-container *ngIf="interaction.permissionList$ | async as list">
                <span [ngClass]="list.includes(selected.data.id) ? 'status-unlocked' : 'status-locked'">
                  {{ list.includes(selected.data.id) ? 'UNLOCKED' : 'LOCKED' }}
                </span>
              </ng-container>
            </p>
          </div>
          <div class="detail-section" *ngSwitchDefault>
            <p class="detail-description">รอข้อมูลเพิ่มเติมสำหรับพื้นที่นี้</p>
          </div>
        </ng-container>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
