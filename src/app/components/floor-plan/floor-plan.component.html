<div [class.fullscreen]="isFullscreen" class="floor-plan-wrapper">
  <canvas #canvas></canvas>

  <div class="floor-plan-toolbar" (click)="$event.stopPropagation()">
    <div class="floor-toolbar-left" *ngIf="floorData">
      <div class="floor-dropdown" *ngIf="floorOptions.length">
        <ion-item lines="none" class="floor-dropdown__control">
          <ion-label>เลือกชั้น</ion-label>
          <ion-select
            interface="action-sheet"
            [value]="activeFloorValue"
            (ionChange)="onFloorSelectionChange($event.detail.value)"
            placeholder="เลือกชั้น"
          >
            <ion-select-option *ngFor="let option of floorOptions" [value]="option.value">
              {{ option.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </div>
    </div>

    <div class="toolbar-meta">
      <div class="toolbar-actions">
        <ion-button size="small" color="dark" fill="solid" class="toolbar-button" (click)="toggleView()">
          <ion-icon slot="start" [name]="currentView === 'iso' ? 'cube-outline' : 'map-outline'"></ion-icon>
          {{ currentView === 'iso' ? 'มุมมองอาคาร' : 'มุมมองจากบน' }}
        </ion-button>
        <ion-button size="small" color="dark" fill="solid" class="toolbar-icon-button" (click)="toggleFullscreen()">
          <ion-icon [name]="isFullscreen ? 'contract-outline' : 'expand-outline'" slot="icon-only"></ion-icon>
        </ion-button>
      </div>

      <div class="info-display-container">
        <div class="chip" *ngIf="interaction.currentZoneId$ | async as zoneId">
          <ion-icon name="location-outline"></ion-icon>
          <span>{{ zoneId }}</span>
        </div>
        <div class="chip" *ngIf="playerPositionDisplay$ | async as position">
          <ion-icon name="compass-outline"></ion-icon>
          <span>{{ position }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="camera-control-stack" (click)="$event.stopPropagation()">
    <ion-button
      shape="round"
      fill="solid"
      color="light"
      size="large"
      class="control-button joystick-toggle"
      [class.active]="isJoystickVisible"
      (click)="toggleJoystickVisibility()"
      [aria-pressed]="isJoystickVisible"
      aria-label="สลับการแสดงจอยสติ๊ก"
    >
      <ion-icon slot="icon-only" name="game-controller-outline"></ion-icon>
    </ion-button>

    <div class="zoom-controls">
      <ion-button
        size="large"
        fill="clear"
        class="zoom-button"
        (click)="adjustCameraZoom('in')"
        [disabled]="!canZoomIn"
        aria-label="ซูมเข้า"
      >
        <ion-icon slot="icon-only" name="add"></ion-icon>
      </ion-button>
      <span class="zoom-divider"></span>
      <ion-button
        size="large"
        fill="clear"
        class="zoom-button"
        (click)="adjustCameraZoom('out')"
        [disabled]="!canZoomOut"
        aria-label="ซูมออก"
      >
        <ion-icon slot="icon-only" name="remove"></ion-icon>
      </ion-button>
    </div>
  </div>

  <app-joystick *ngIf="isJoystickVisible"></app-joystick>
</div>

<ion-modal
  [isOpen]="detailDialogVisible"
  (didDismiss)="onDialogHide()"
  cssClass="floor-detail-modal"
  [backdropDismiss]="true"
>
  <ng-template>
    <ion-header>
      <ion-toolbar color="light">
        <ion-title>รายละเอียดพื้นที่</ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" (click)="onDialogHide()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <div *ngIf="interaction.selectedObject$ | async as selected" class="detail-content" (click)="$event.stopPropagation()">
        <div class="detail-header">
          <h3>{{ selected.data?.name || selected.data?.id }}</h3>
          <p class="detail-subtitle">
            {{ selected.type | titlecase }} • ชั้น {{ selected.data?.floor ?? floorData?.floor }}
          </p>
        </div>

        <ng-container [ngSwitch]="selected.type">
          <div class="detail-section" *ngSwitchCase="'door'">
            <h4>สิทธิ์การเข้าใช้งาน</h4>
            <p>
              <strong>ID ประตู:</strong>
              {{ selected.data.id }}
            </p>
            <p>
              <strong>สถานะ:</strong>
              <ng-container *ngIf="interaction.permissionList$ | async as list">
                <span [ngClass]="list.includes(selected.data.id) ? 'status-unlocked' : 'status-locked'">
                  {{ list.includes(selected.data.id) ? 'UNLOCKED' : 'LOCKED' }}
                </span>
              </ng-container>
            </p>
          </div>
          <div class="detail-section" *ngSwitchDefault>
            <p class="detail-description">รอข้อมูลเพิ่มเติมสำหรับพื้นที่นี้</p>
          </div>
        </ng-container>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
